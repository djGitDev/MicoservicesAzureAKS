stages:
  - deploy

deploy_to_vm:
  stage: deploy
  image: alpine:latest
  only:
    - master
  before_script:
    - apk add --no-cache openssh tar
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts
  script:
    - echo "ðŸ“¦ CrÃ©ation de l'archive"
    - tar -czf app.tar.gz .
    - echo "ðŸš€ Envoi de l'application Ã  $REMOTE_HOST"
    - scp app.tar.gz $REMOTE_USER@$REMOTE_HOST:~/app.tar.gz
    - echo "ðŸ§© DÃ©ploiement sur $REMOTE_HOST"
    - ssh $REMOTE_USER@$REMOTE_HOST "
        mkdir -p ~/my-app &&
        tar -xzf ~/app.tar.gz -C ~/my-app &&
        cd ~/my-app &&
        docker-compose down &&
        docker-compose up --build -d
      "
  