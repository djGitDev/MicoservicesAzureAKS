


image: docker:24.0.7

services:
  - name: docker:dind
    alias: docker-dind
    variables:
      DOCKER_TLS_CERTDIR: ""
      DOCKER_OPTS: "--host=tcp://0.0.0.0:2375 --debug"  # Mode debug activ√©

variables:
  DOCKER_HOST: tcp://docker-dind:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

stages:
  - build

before_script:
  - apk add --no-cache docker-cli-compose curl netcat-openbsd bind-tools
  - |
    echo "üîç D√©marrage du diagnostic r√©seau"
    echo "1. R√©solution DNS:"
    nslookup docker-dind || drill docker-dind || true
    
    echo "2. Table de routage:"
    ip route
    
    echo "3. Interfaces r√©seau:"
    ip addr
    
    echo "4. Ports en √©coute LOCAUX:"
    netstat -tuln
    
    echo "5. Test de connectivit√© TCP:"
    timeout 30 sh -c 'while ! nc -zv docker-dind 2375; do sleep 2; echo "Port 2375 ferm√©..."; done'
    
    echo "6. V√©rification HTTP:"
    curl -v --max-time 5 http://docker-dind:2375/_ping || true

build:
  stage: build
  script:
    - echo "üõ†Ô∏è D√©but de la construction"
    - docker compose version
    - docker info || true  # Continue m√™me en cas d'erreur
    
    # Test minimal de fonctionnement Docker
    - docker run --rm hello-world || true
    
    # Construction r√©elle
    - docker compose build
    - echo "‚úÖ Build termin√©"

